version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    restart: always
    command:
      # Uncomment to enable Traefik dashboard
      #- "--api.dashboard=true"
      #- "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Enable Let's Encrypt
      - "--certificatesresolvers.le.acme.email=christian@billify.be"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.le.acme.tlschallenge=true"
      # Enable HTTPS redirection
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Security headers
      - "--entrypoints.websecure.http.middlewares=securityheaders@docker"
    ports:
      - "80:80"
      - "443:443"
      #- "8080:8080" # Traefik dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./letsencrypt:/letsencrypt"
    depends_on:
      - backend
    networks:
      - billify_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`app.billify.be`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=le"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.http.routers.backend.rule=Host(`api.billify.be`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=le"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
  traefik-security-headers:
    image: traefik:v3.0
    command:
      - "--providers.docker=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.sslredirect=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.stsincludesubdomains=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.stspreload=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.contenttypenosniff=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.browserxssfilter=true"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.referrerpolicy=strict-origin-when-cross-origin"
      - "--entrypoints.websecure.http.middlewares=securityheaders.headers.framedeny=true"
    networks:
      - billify_network
  backend:
    image: $BACKEND_IMAGE
    restart: always
    environment:
      - DEBUG=0
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
      - ALLOWED_HOSTS=localhost,api.billify.be,127.0.0.1
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      - CORS_ALLOWED_ORIGINS=https://app.billify.be
      - AWS_ACCESS_KEY_ID=${MINIO_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_PASSWORD}
      - AWS_STORAGE_BUCKET_NAME=billify
      - AWS_S3_ENDPOINT_URL=http://minio:9000
      - REDIS_URL=redis://redis:6379/0
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.django.rule=Host(`api.billify.be`)"
      - "traefik.http.routers.django.entrypoints=websecure"
      - "traefik.http.routers.django.tls.certresolver=le"
      - "traefik.http.services.django.loadbalancer.server.port=8000"
    depends_on:
      - db
      - redis
      - minio
    networks:
      - billify_network
  frontend:
    image: $FRONTEND_IMAGE
    environment:
      - NEXT_PUBLIC_BACKEND_URL=https://api.billify.be
      - NEXT_PUBLIC_DEBUG=false
      - NODE_ENV=production
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextjs.rule=Host(`app.billify.be`)"
      - "traefik.http.routers.nextjs.entrypoints=websecure"
      - "traefik.http.routers.nextjs.tls.certresolver=le"
      - "traefik.http.services.nextjs.loadbalancer.server.port=3000"
    depends_on:
      - backend
    networks:
      - billify_network

  db:
    image: postgres:15-alpine
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - billify_network

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - billify_network

  minio:
    image: minio/minio
    restart: always
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    command: server --console-address ":9001" /data
    networks:
      - billify_network

volumes:
  postgres_data:
    external: true
  minio_data:
    external: true

networks:
  billify_network:
    driver: bridge